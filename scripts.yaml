sonos_say:
  alias: Sonos TTS Script
  sequence:
  - data_template:
      entity_id: "media_player.{{ sonos_id }}"
      with_group: yes
    service: media_player.sonos_snapshot
  - data_template:
      entity_id: "media_player.{{ sonos_id }}"
    service: media_player.sonos_unjoin
  - data_template:
      entity_id: "media_player.{{ sonos_id }}"
      volume_level: "{{ volume }}"
    service: media_player.volume_set
  - data_template:
      entity_id: "media_player.{{ sonos_id }}"
      message: "{{ message }}"
    service: tts.voicerss_say
  # Add a delay in a length which you think fits best for all things you want to say over TTS
  - delay:
      seconds: 1
  - delay: >-
      {% set duration = states.media_player[sonos_id].attributes.media_duration %}
      {% if duration > 0 %}
      {% set duration = duration - 1 %}
      {% endif %}
      {% set seconds = duration % 60 %}
      {% set minutes = (duration / 60)|int % 60 %}
      {% set hours = (duration / 3600)|int %}
      {{ [hours, minutes, seconds]|join(':') }}      
  - data_template:
      entity_id: "media_player.{{ sonos_id }}"
      with_group: yes
    service: media_player.sonos_restore
